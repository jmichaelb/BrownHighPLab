function UltraSonicStrc=UltraSonicSpeed(UltraSonicStrc,fitid,pltflg)
% Function to find a 2-way travel time that matches data and return the
% speed of sound.  
%  Usage: vel=UltraSonicSpeed(UltraSonicStc,fitid)
% where UltraSonicStc is the data structure and fitid is the list of peaks
% to fit for the velocity determination

t=UltraSonicStrc.t;
TF=UltraSonicStrc.TF;
signal=UltraSonicStrc.signal;
pks=UltraSonicStrc.pks;
Tin=UltraSonicStrc.T;
Pin=UltraSonicStrc.P/1e3;
sampl_length=(1-Pin/110/3)*TiExpansivty(Tin)*UltraSonicStrc.sampl_length;

npks=length(pks);
fitpk=zeros(npks,1);
for i=1:npks
    id=find(t>pks(i)-.06 & t<pks(i)+.06);
    if i==1,
        pp=spline(t(id),-TF(id));
    else
        pp=spline(t(id),TF(id));
    end
    x=t(id);
    fitpk(i)=fminbnd(@(x) ppval(pp,x),t(id(1)),t(id(end)));
    UltraSonicStrc.pp(i)=pp;
    UltraSonicStrc.id{i}=id;
    UltraSonicStrc.fitpk(i)=fitpk(i);
end

x=(0:(npks-1))*sampl_length*2;
x=x(fitid);
y=fitpk(fitid)';
[a,b,da,db]=linreg(x,y,2e-3*ones(1,length(fitid)));
vel=b^(-1)*1e3;
yc=polyval([b a],x);
misfit=y-yc;
rms=sqrt(sum((misfit).^2));
[a,b,da,db]=linreg(x,y,rms*ones(1,length(fitid)));
del_vel=1/b*2*db/b*1e3;
delplt=fix(100*del_vel);
tw=2*sampl_length/vel*1e3;
[~,~,~,~,~,~,veliapws]=IAPWS(Pin,273.15+Tin);

txt=sprintf('     rms misfit   = %5.4f microseconds',rms);
txt2=sprintf('Sound Speed = %7.2f(%2i) m/s',vel,delplt);
txt3=sprintf('Travel Time   = %7.4f microseconds',tw);
txt4=sprintf('IAPWS = %7.2f m/s (%5.2f °C %5.1f MPa)',veliapws*1e3,Tin,Pin*1e3);
txt5=sprintf(['Filename = ' UltraSonicStrc.filename]);
it=find(txt5=='_');
txt5(it(1))=' ';
txt5(it(2))=' ';
txt6=sprintf(' %2i',fitid);
txt6=['Reflections fit ' txt6];
txt7=sprintf('Damping=%4.2f Method ',UltraSonicStrc.lambda);
txt7=[txt7 UltraSonicStrc.flg_decon];
txt8={'Buffer Rod Reflection'
'First Sample Refelction'
'Second Sample Reflection'
'Third Sample Reflection'
'Fourth Sample Reflection'
'Fith Sample Reflection'
'Sixth Sample Reflection'
'Seventh Sample Reflection'
};
txt9='Second Buffer rod Reflection';
t_sig=t-fitpk(1);
idGC1=find(t_sig<5);
idGC2=find(t<5);
if strcmp(pltflg,'y')
scrsz=get(0,'ScreenSize');
figsz=[1 .8*scrsz(4) .95*scrsz(3) .8*scrsz(4)];
fig_handle=figure('Name',UltraSonicStrc.filename,'Position',figsz);

subplot(211)
plot(t_sig(idGC1)-0,signal(idGC1)/5+.1,'k-',t_sig(idGC1(end):end)-0,signal(idGC1(end):end)+.1,'k',t(idGC2),-.3*TF(idGC2)-.3,'k-', t(idGC2(end):end),-3*TF(idGC2(end):end)-.3,'k-')
hold on
for i=1:npks
  plot([fitpk(i) fitpk(i)],[-3 3],'k:','LineWidth',2);
  text(fitpk(i)+.1,.4,txt8{i},'FontSize',10)
end
text(fitpk(1)+55.5,.3,txt9,'FontSize',10)
hold off

xlabel('Time (microsec)')
axis([-1 80 -.5 .5])

subplot(212)
for i=1:npks
    pp=UltraSonicStrc.pp(i);
    id=UltraSonicStrc.id{i};
    tc=t(id(1)):.0001:t(id(end));
    yc=ppval(pp,tc);
    if i==1
    plot(t(id)-fitpk(i),TF(id)/5,'o',tc-fitpk(i),-yc/5,'k-','LineWidth',2)
    else
     plot(t(id)-fitpk(i),-TF(id),'o',tc-fitpk(i),-yc,'k-','LineWidth',2)
    end
hold on
end
plot([0 0],[.5 -.5],'k-','LineWidth',2)
axis([-.08 .08 -.05 .15])
hold off
text(-.075 ,.13,txt2,'FontSize',20)
text(.025,.13,txt3,'FontSize',20)
text(.025,.11,txt,'FontSize',20)
text(-.075 ,.09,txt5,'FontSize',20)
text(-.075,.11,txt4,'FontSize',20)
text(.05,.09,txt6,'FontSize',15)
text(.05,.08,txt7,'FontSize',15)
xlabel('Time (microsec)')
hold off
end
set(gcf,'PaperType','tabloid')

UltraSonicStrc.vel=vel;
UltraSonicStrc.rms=rms;
UltraSonicStrc.del_vel=del_vel;
UltraSonicStrc.tw=tw;
UltraSonicStrc.veliapws=veliapws;
UltraSonicStrc.misfit=misfit;

eval(['save ' UltraSonicStrc.filename ' UltraSonicStrc'])
%print(fig_handle,'-depsc','testagain')

function [del_length,alpha]=TiExpansivty(T)
% Based on NIST RESEARCH PAPER RP1520
% [del_length,alpha]=TiExpansivty(T);
% figure 3 was digitized and fit with a spline and integrated to create a
% table in 1 deg increments. This is linear expansivity centered at 20°C
data=[
 -100.0000    6.5884   -9.1805
  -99.0000    6.6071   -9.1145
  -98.0000    6.6259   -9.0483
  -97.0000    6.6448   -8.9820
  -96.0000    6.6639   -8.9155
  -95.0000    6.6830   -8.8487
  -94.0000    6.7023   -8.7818
  -93.0000    6.7217   -8.7147
  -92.0000    6.7412   -8.6474
  -91.0000    6.7608   -8.5798
  -90.0000    6.7805   -8.5121
  -89.0000    6.8003   -8.4442
  -88.0000    6.8203   -8.3761
  -87.0000    6.8404   -8.3078
  -86.0000    6.8606   -8.2393
  -85.0000    6.8809   -8.1706
  -84.0000    6.9013   -8.1017
  -83.0000    6.9218   -8.0326
  -82.0000    6.9424   -7.9633
  -81.0000    6.9632   -7.8937
  -80.0000    6.9841   -7.8240
  -79.0000    7.0051   -7.7541
  -78.0000    7.0261   -7.6839
  -77.0000    7.0472   -7.6135
  -76.0000    7.0684   -7.5430
  -75.0000    7.0895   -7.4722
  -74.0000    7.1107   -7.4012
  -73.0000    7.1318   -7.3300
  -72.0000    7.1529   -7.2585
  -71.0000    7.1739   -7.1869
  -70.0000    7.1948   -7.1151
  -69.0000    7.2156   -7.0430
  -68.0000    7.2363   -6.9707
  -67.0000    7.2568   -6.8983
  -66.0000    7.2771   -6.8256
  -65.0000    7.2972   -6.7527
  -64.0000    7.3171   -6.6797
  -63.0000    7.3368   -6.6064
  -62.0000    7.3562   -6.5329
  -61.0000    7.3754   -6.4593
  -60.0000    7.3942   -6.3854
  -59.0000    7.4127   -6.3114
  -58.0000    7.4309   -6.2372
  -57.0000    7.4489   -6.1628
  -56.0000    7.4665   -6.0882
  -55.0000    7.4839   -6.0134
  -54.0000    7.5010   -5.9385
  -53.0000    7.5179   -5.8634
  -52.0000    7.5345   -5.7882
  -51.0000    7.5509   -5.7127
  -50.0000    7.5671   -5.6371
  -49.0000    7.5831   -5.5614
  -48.0000    7.5988   -5.4855
  -47.0000    7.6144   -5.4094
  -46.0000    7.6297   -5.3332
  -45.0000    7.6449   -5.2568
  -44.0000    7.6599   -5.1803
  -43.0000    7.6748   -5.1036
  -42.0000    7.6895   -5.0268
  -41.0000    7.7041   -4.9498
  -40.0000    7.7185   -4.8727
  -39.0000    7.7328   -4.7955
  -38.0000    7.7469   -4.7181
  -37.0000    7.7610   -4.6405
  -36.0000    7.7750   -4.5628
  -35.0000    7.7888   -4.4850
  -34.0000    7.8026   -4.4071
  -33.0000    7.8164   -4.3290
  -32.0000    7.8300   -4.2507
  -31.0000    7.8436   -4.1724
  -30.0000    7.8572   -4.0939
  -29.0000    7.8707   -4.0152
  -28.0000    7.8842   -3.9365
  -27.0000    7.8977   -3.8575
  -26.0000    7.9111   -3.7785
  -25.0000    7.9246   -3.6993
  -24.0000    7.9380   -3.6200
  -23.0000    7.9515   -3.5406
  -22.0000    7.9650   -3.4610
  -21.0000    7.9784   -3.3813
  -20.0000    7.9919   -3.3014
  -19.0000    8.0053   -3.2214
  -18.0000    8.0188   -3.1413
  -17.0000    8.0322   -3.0611
  -16.0000    8.0456   -2.9807
  -15.0000    8.0590   -2.9001
  -14.0000    8.0724   -2.8195
  -13.0000    8.0858   -2.7387
  -12.0000    8.0992   -2.6578
  -11.0000    8.1125   -2.5767
  -10.0000    8.1258   -2.4955
   -9.0000    8.1391   -2.4142
   -8.0000    8.1523   -2.3327
   -7.0000    8.1655   -2.2511
   -6.0000    8.1787   -2.1694
   -5.0000    8.1918   -2.0876
   -4.0000    8.2049   -2.0056
   -3.0000    8.2180   -1.9235
   -2.0000    8.2310   -1.8412
   -1.0000    8.2439   -1.7589
         0    8.2569   -1.6764
    1.0000    8.2697   -1.5937
    2.0000    8.2826   -1.5110
    3.0000    8.2953   -1.4281
    4.0000    8.3080   -1.3451
    5.0000    8.3207   -1.2619
    6.0000    8.3333   -1.1786
    7.0000    8.3458   -1.0952
    8.0000    8.3582   -1.0117
    9.0000    8.3706   -0.9281
   10.0000    8.3830   -0.8443
   11.0000    8.3952   -0.7604
   12.0000    8.4074   -0.6764
   13.0000    8.4195   -0.5923
   14.0000    8.4315   -0.5080
   15.0000    8.4434   -0.4236
   16.0000    8.4553   -0.3391
   17.0000    8.4671   -0.2545
   18.0000    8.4788   -0.1698
   19.0000    8.4904   -0.0850
   20.0000    8.5019         0
   21.0000    8.5133    0.0851
   22.0000    8.5247    0.1703
   23.0000    8.5360    0.2556
   24.0000    8.5472    0.3410
   25.0000    8.5583    0.4265
   26.0000    8.5694    0.5122
   27.0000    8.5803    0.5979
   28.0000    8.5912    0.6838
   29.0000    8.6020    0.7697
   30.0000    8.6127    0.8558
   31.0000    8.6234    0.9420
   32.0000    8.6339    1.0283
   33.0000    8.6444    1.1147
   34.0000    8.6548    1.2012
   35.0000    8.6651    1.2878
   36.0000    8.6754    1.3745
   37.0000    8.6855    1.4613
   38.0000    8.6956    1.5482
   39.0000    8.7057    1.6352
   40.0000    8.7156    1.7223
   41.0000    8.7254    1.8095
   42.0000    8.7352    1.8968
   43.0000    8.7449    1.9842
   44.0000    8.7546    2.0717
   45.0000    8.7641    2.1593
   46.0000    8.7736    2.2470
   47.0000    8.7830    2.3348
   48.0000    8.7923    2.4226
   49.0000    8.8016    2.5106
   50.0000    8.8108    2.5987
   51.0000    8.8199    2.6868
   52.0000    8.8289    2.7751
   53.0000    8.8378    2.8634
   54.0000    8.8467    2.9518
   55.0000    8.8555    3.0403
   56.0000    8.8643    3.1289
   57.0000    8.8729    3.2176
   58.0000    8.8815    3.3064
   59.0000    8.8900    3.3952
   60.0000    8.8985    3.4842
   61.0000    8.9069    3.5732
   62.0000    8.9152    3.6623
   63.0000    8.9234    3.7515
   64.0000    8.9316    3.8408
   65.0000    8.9397    3.9301
   66.0000    8.9478    4.0196
   67.0000    8.9558    4.1091
   68.0000    8.9637    4.1987
   69.0000    8.9716    4.2884
   70.0000    8.9794    4.3781
   71.0000    8.9871    4.4680
   72.0000    8.9948    4.5579
   73.0000    9.0025    4.6479
   74.0000    9.0101    4.7379
   75.0000    9.0176    4.8281
   76.0000    9.0251    4.9183
   77.0000    9.0325    5.0086
   78.0000    9.0399    5.0989
   79.0000    9.0472    5.1894
   80.0000    9.0545    5.2799
   81.0000    9.0617    5.3704
   82.0000    9.0689    5.4611
   83.0000    9.0760    5.5518
   84.0000    9.0831    5.6426
   85.0000    9.0902    5.7335
   86.0000    9.0972    5.8244
   87.0000    9.1041    5.9154
   88.0000    9.1110    6.0065
   89.0000    9.1179    6.0976
   90.0000    9.1248    6.1889
   91.0000    9.1316    6.2801
   92.0000    9.1384    6.3715
   93.0000    9.1451    6.4629
   94.0000    9.1518    6.5544
   95.0000    9.1585    6.6459
   96.0000    9.1651    6.7376
   97.0000    9.1717    6.8292
   98.0000    9.1783    6.9210
   99.0000    9.1848    7.0128
  100.0000    9.1914    7.1047
  101.0000    9.1978    7.1966
  102.0000    9.2043    7.2887
  103.0000    9.2108    7.3807
  104.0000    9.2172    7.4729
  105.0000    9.2236    7.5651
  106.0000    9.2299    7.6573
  107.0000    9.2363    7.7497
  108.0000    9.2426    7.8421
  109.0000    9.2489    7.9345
  110.0000    9.2552    8.0270
  111.0000    9.2615    8.1196
  112.0000    9.2677    8.2123
  113.0000    9.2739    8.3050
  114.0000    9.2801    8.3977
  115.0000    9.2863    8.4906
  116.0000    9.2925    8.5835
  117.0000    9.2986    8.6764
  118.0000    9.3047    8.7694
  119.0000    9.3108    8.8625
  120.0000    9.3169    8.9557
  121.0000    9.3229    9.0489
  122.0000    9.3290    9.1421
  123.0000    9.3350    9.2354
  124.0000    9.3410    9.3288
  125.0000    9.3470    9.4223
  126.0000    9.3529    9.5158
  127.0000    9.3589    9.6093
  128.0000    9.3648    9.7029
  129.0000    9.3707    9.7966
  130.0000    9.3766    9.8904
  131.0000    9.3825    9.9841
  132.0000    9.3883   10.0780
  133.0000    9.3942   10.1719
  134.0000    9.4000   10.2659
  135.0000    9.4058   10.3599
  136.0000    9.4116   10.4540
  137.0000    9.4174   10.5481
  138.0000    9.4231   10.6424
  139.0000    9.4289   10.7366
  140.0000    9.4346   10.8309
  141.0000    9.4403   10.9253
  142.0000    9.4460   11.0197
  143.0000    9.4517   11.1142
  144.0000    9.4573   11.2088
  145.0000    9.4630   11.3034
  146.0000    9.4686   11.3980
  147.0000    9.4743   11.4927
  148.0000    9.4799   11.5875
  149.0000    9.4855   11.6823
  150.0000    9.4910   11.7772
  151.0000    9.4966   11.8722
  152.0000    9.5021   11.9672
  153.0000    9.5077   12.0622
  154.0000    9.5132   12.1573
  155.0000    9.5187   12.2525
  156.0000    9.5242   12.3477
  157.0000    9.5297   12.4430
  158.0000    9.5352   12.5383
  159.0000    9.5407   12.6337
  160.0000    9.5461   12.7291
  161.0000    9.5516   12.8246
  162.0000    9.5570   12.9201
  163.0000    9.5624   13.0157
  164.0000    9.5678   13.1114
  165.0000    9.5732   13.2071
  166.0000    9.5786   13.3028
  167.0000    9.5840   13.3986
  168.0000    9.5893   13.4945
  169.0000    9.5947   13.5904
  170.0000    9.6001   13.6864
  171.0000    9.6054   13.7824
  172.0000    9.6107   13.8785
  173.0000    9.6161   13.9746
  174.0000    9.6214   14.0708
  175.0000    9.6267   14.1671
  176.0000    9.6320   14.2634
  177.0000    9.6373   14.3597
  178.0000    9.6426   14.4561
  179.0000    9.6479   14.5526
  180.0000    9.6532   14.6491
  181.0000    9.6585   14.7456
  182.0000    9.6638   14.8422
  183.0000    9.6691   14.9389
  184.0000    9.6743   15.0356
  185.0000    9.6796   15.1324
  186.0000    9.6849   15.2292
  187.0000    9.6902   15.3261
  188.0000    9.6954   15.4230
  189.0000    9.7007   15.5200
  190.0000    9.7060   15.6170
  191.0000    9.7113   15.7141
  192.0000    9.7165   15.8113
  193.0000    9.7218   15.9085
  194.0000    9.7271   16.0057
  195.0000    9.7324   16.1030
  196.0000    9.7377   16.2003
  197.0000    9.7429   16.2977
  198.0000    9.7482   16.3952
  199.0000    9.7535   16.4927
  200.0000    9.7588   16.5903];
data(:,3)=data(:,3)*1e-4;
data(:,2)=data(:,2)*1e-6;

alpha=interp1(data(:,1),data(:,2),T);
del_length=1+interp1(data(:,1),data(:,3),T);